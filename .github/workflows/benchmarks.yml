name: Performance Benchmarks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  benchmark:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          g++-11 \
          libssl-dev \
          pkg-config
    
    - name: Build optimized
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_COMPILER=g++-11 \
          -DCMAKE_CXX_FLAGS="-O3 -march=native -flto"
        cmake --build build -j$(nproc)
    
    - name: Memory pool benchmark
      run: |
        cd build
        echo "=== Memory Pool Benchmark ===" | tee -a benchmark_results.txt
        ./bench_memory_pool --iterations 1000000 | tee -a benchmark_results.txt
    
    - name: Matching engine benchmark
      run: |
        cd build
        echo "" | tee -a benchmark_results.txt
        echo "=== Matching Engine Benchmark ===" | tee -a benchmark_results.txt
        ./bench_matching --orders 100000 --symbols 3 | tee -a benchmark_results.txt
    
    - name: End-to-end benchmark
      run: |
        cd build
        export RTES_HMAC_KEY=$(openssl rand -hex 32)
        ./trading_exchange ../configs/config.json &
        EXCHANGE_PID=$!
        sleep 5
        
        echo "" | tee -a benchmark_results.txt
        echo "=== End-to-End Benchmark ===" | tee -a benchmark_results.txt
        timeout 60s ./bench_exchange --clients 50 --duration 30 | tee -a benchmark_results.txt || true
        
        kill $EXCHANGE_PID 2>/dev/null || true
        wait $EXCHANGE_PID 2>/dev/null || true
    
    - name: Performance regression check
      run: |
        cd build
        python3 << 'EOF'
        import re
        
        with open('benchmark_results.txt', 'r') as f:
            content = f.read()
        
        # Extract latency metrics
        avg_match = re.search(r'Average.*?(\d+\.?\d*)\s*[μu]s', content)
        p99_match = re.search(r'P99.*?(\d+\.?\d*)\s*[μu]s', content)
        
        if avg_match:
            avg_latency = float(avg_match.group(1))
            print(f"Average latency: {avg_latency}μs")
            if avg_latency > 15:
                print(f"WARNING: Average latency {avg_latency}μs exceeds threshold 15μs")
        
        if p99_match:
            p99_latency = float(p99_match.group(1))
            print(f"P99 latency: {p99_latency}μs")
            if p99_latency > 150:
                print(f"WARNING: P99 latency {p99_latency}μs exceeds threshold 150μs")
        EOF
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: benchmark-results-${{ github.sha }}
        path: build/benchmark_results.txt
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const results = fs.readFileSync('build/benchmark_results.txt', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## Performance Benchmark Results\n\n\`\`\`\n${results}\n\`\`\``
          });

  stress-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake g++-11 libssl-dev pkg-config
    
    - name: Build
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=g++-11
        cmake --build build -j$(nproc)
    
    - name: Run stress test
      run: |
        cd build
        export RTES_HMAC_KEY=$(openssl rand -hex 32)
        ./trading_exchange ../configs/config.json &
        EXCHANGE_PID=$!
        sleep 5
        
        echo "=== Stress Test ===" | tee stress_results.txt
        timeout 120s ./load_generator --clients 200 --rate 1000 --duration 60 | tee -a stress_results.txt || true
        
        kill $EXCHANGE_PID 2>/dev/null || true
        wait $EXCHANGE_PID 2>/dev/null || true
    
    - name: Upload stress test results
      uses: actions/upload-artifact@v3
      with:
        name: stress-test-results
        path: build/stress_results.txt
