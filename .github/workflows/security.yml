name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight
  workflow_dispatch:

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'cpp' ]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}
        queries: security-and-quality
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake g++-11 libssl-dev pkg-config
    
    - name: Build
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=g++-11
        cmake --build build -j$(nproc)
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  docker-security:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: docker build -t rtes:security-scan .
    
    - name: Run Trivy on Docker image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'rtes:security-scan'
        format: 'sarif'
        output: 'trivy-docker-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: Upload Docker scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-docker-results.sarif'

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified

  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          g++-11 \
          clang-tidy-13 \
          cppcheck \
          libssl-dev \
          pkg-config
    
    - name: Run cppcheck
      run: |
        cppcheck --enable=all --inconclusive --xml --xml-version=2 \
          --suppress=missingIncludeSystem \
          -I include/ src/ 2> cppcheck-report.xml || true
    
    - name: Run clang-tidy
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_COMPILER=g++-11 \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        
        find src/ -name "*.cpp" | xargs clang-tidy-13 \
          -p build/ \
          --checks='*,-fuchsia-*,-google-*,-llvm-*,-modernize-use-trailing-return-type' \
          > clang-tidy-report.txt 2>&1 || true
    
    - name: Upload static analysis results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: static-analysis-results
        path: |
          cppcheck-report.xml
          clang-tidy-report.txt

  sanitizer-tests:
    name: Sanitizer Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        sanitizer: [address, undefined, thread]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake g++-11 libgtest-dev libssl-dev pkg-config
    
    - name: Build with ${{ matrix.sanitizer }} sanitizer
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_COMPILER=g++-11 \
          -DCMAKE_CXX_FLAGS="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer -g"
        cmake --build build -j$(nproc)
    
    - name: Run tests with ${{ matrix.sanitizer }} sanitizer
      run: |
        cd build
        export ASAN_OPTIONS=detect_leaks=1:halt_on_error=1
        export UBSAN_OPTIONS=print_stacktrace=1:halt_on_error=1
        export TSAN_OPTIONS=halt_on_error=1
        ctest --output-on-failure --timeout 300 || true
    
    - name: Upload sanitizer logs
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: sanitizer-${{ matrix.sanitizer }}-logs
        path: build/Testing/

  security-audit:
    name: Security Audit Report
    runs-on: ubuntu-latest
    needs: [codeql-analysis, dependency-scan, secret-scan, static-analysis]
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Generate security report
      run: |
        cat << 'EOF' > security-report.md
        # Security Audit Report
        
        **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Commit**: ${{ github.sha }}
        **Branch**: ${{ github.ref_name }}
        
        ## Scan Results
        
        - CodeQL Analysis: ${{ needs.codeql-analysis.result }}
        - Dependency Scan: ${{ needs.dependency-scan.result }}
        - Secret Detection: ${{ needs.secret-scan.result }}
        - Static Analysis: ${{ needs.static-analysis.result }}
        
        ## Recommendations
        
        1. Review all findings in GitHub Security tab
        2. Address CRITICAL and HIGH severity issues immediately
        3. Update dependencies with known vulnerabilities
        4. Rotate any exposed secrets
        5. Fix static analysis warnings
        
        ## Next Steps
        
        - [ ] Review security findings
        - [ ] Create issues for vulnerabilities
        - [ ] Update security documentation
        - [ ] Schedule security review meeting
        
        EOF
    
    - name: Upload security report
      uses: actions/upload-artifact@v3
      with:
        name: security-audit-report
        path: security-report.md
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
